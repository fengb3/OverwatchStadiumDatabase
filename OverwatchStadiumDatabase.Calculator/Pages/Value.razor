@page "/value"
@using Microsoft.EntityFrameworkCore
@using OverwatchStadiumDatabase
@using OverwatchStadiumDatabase.Models
@using OverwatchStadiumDatabase.Calculator.Services

<PageTitle>Value</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Item Value (Common baseline)</MudText>

@if (isLoading)
{
    <MudProgressLinear Indeterminate="true" />
}
else
{
    <MudText Typo="Typo.h6" Class="mt-4">Common unit price by buff</MudText>

    @if (unitPriceRows.Count == 0)
    {
        <MudText Color="Color.Secondary">No common-baseline unit prices could be derived.</MudText>
    }
    else
    {
        <MudTable Items="unitPriceRows" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Buff</MudTh>
                <MudTh Style="text-align:right">Unit price (per 1 value)</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Buff">@context.BuffName</MudTd>
                <MudTd DataLabel="Unit" Style="text-align:right">@context.UnitPrice</MudTd>
            </RowTemplate>
        </MudTable>
    }

    <MudDivider Class="my-6" />

    <MudText Typo="Typo.h6">Items</MudText>

    @foreach (var group in itemBreakdowns.GroupBy(i => i.Type).OrderBy(g => g.Key))
    {
        <MudText Typo="Typo.h5" Class="mt-6 mb-2">@group.Key</MudText>

        <MudExpansionPanels MultiExpansion="true" Dense="true">
            @foreach (var item in group.OrderBy(i => i.Name))
            {
                <MudExpansionPanel>
                    <TitleContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.subtitle1"><b>@item.Name</b></MudText>
                                <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled">@item.Rarity</MudChip>
                            </MudStack>

                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudText>Cost: <b>@item.Cost</b></MudText>
                                <MudText>Base: <b>@item.BaseBuffValue</b></MudText>
                                <MudText>Extra: <b>@item.ExtraValue</b></MudText>
                            </MudStack>
                        </MudStack>
                    </TitleContent>

                    <ChildContent>
                        @if (!string.IsNullOrWhiteSpace(GetItemDescription(item.ItemId)))
                        {
                            <MudText Class="mb-3">@GetItemDescription(item.ItemId)</MudText>
                        }

                        @if (item.Contributions.Count == 0)
                        {
                            <MudText Color="Color.Secondary">No buffs.</MudText>
                        }
                        else
                        {
                            <MudTable Items="item.Contributions" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>Buff</MudTh>
                                    <MudTh Style="text-align:right">Value</MudTh>
                                    <MudTh Style="text-align:right">Unit</MudTh>
                                    <MudTh Style="text-align:right">Contribution</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Buff">@context.BuffName</MudTd>
                                    <MudTd DataLabel="Value" Style="text-align:right">@context.Value</MudTd>
                                    <MudTd DataLabel="Unit" Style="text-align:right">@context.UnitPrice</MudTd>
                                    <MudTd DataLabel="Contribution" Style="text-align:right">@context.ContributionValue</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    }
}

@code {
    [Inject] public OverwatchStadiumDbContext DbContext { get; set; } = null!;
    [Inject] public ItemValueCalculator ValueCalculator { get; set; } = null!;

    private bool isLoading = true;

    private List<Item> rawItems = new();
    private List<ItemValueCalculator.ItemValueBreakdown> itemBreakdowns = new();
    private List<UnitPriceRow> unitPriceRows = new();

    private sealed record UnitPriceRow(string BuffName, decimal UnitPrice);

    protected override void OnInitialized()
    {
        rawItems = DbContext.Items
        .Include(i => i.ItemBuffs)
        .ThenInclude(ib => ib.Buff)
        .ToList();

        var result = ValueCalculator.Compute(rawItems);

        itemBreakdowns = result.Items.ToList();
        unitPriceRows = result.UnitPriceByBuffName
        .OrderBy(kvp => kvp.Key)
        .Select(kvp => new UnitPriceRow(kvp.Key, kvp.Value))
        .ToList();

        isLoading = false;
    }

    private string GetItemDescription(int itemId)
    => rawItems.FirstOrDefault(i => i.Id == itemId)?.Description ?? string.Empty;
}